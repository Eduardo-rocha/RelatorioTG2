%TCIDATA{LaTeXparent=0,0,relatorio.tex}
                      

\chapter{Projeto de Automação}

% Resumo opcional. Comentar se não usar.
%\resumodocapitulo{Resumo opcional.}

\section{Introdu\c{c}\~{a}o}

Na introdu\c{c}\~{a}o dever\'{a} ser feita uma descri\c{c}\~{a}o geral da
metodologia que foi seguida para o desenvolvimento. A seguir, \'{e} feita a
desci\c{c}\~{a}o do sistema desenvolvido. 

Deve-se ressaltar que equa\c{c}\~{o}es fazem parte do texto, devendo receber pontua\c{c}\~{a}o apropriada e ser numerada. Alguns exemplos s\~{a}o mostrados na se\c{c}\~{a}o \ref
{SecClassificador}.

\section{Metodologia}

O projeto de automação

\section{Modelagem do Sistema}

Primeiramente, modelou-se o comportamento do sistema em uma Máquina de Estados Finita (autômato), de forma a se obter uma descrição simples de como a máquina opera. Em seguida, detalhou-se mais a modelagem por meio de uma rede de Petri, onde alcançou-se um nível de implementação.  A rede de Petri obtida foi simulada para a verificação de que ela atende corretamente aos requisitos do projeto.

\begin{figure}[h]
\centering
\includegraphics[width = .7\linewidth]{figs/automato}
\caption{Automato do funcionamento simplificado do sistema.}
\label{fig:automato}
\end{figure}

\subsection{Modelagem em Máquina de Estados Finita}

A partir da descrição e dos requisitos de projeto, modelou-se o comportamento do sistema com apenas um eixo (um atuador e uma seringa) por meio de um autômato. O intuito do desenvolvimento desse autômato foi para se obter uma melhor compreensão do funcionamento da máquina. 
O autômato desenvolvido pode ser visto na figura \ref{fig:automato} e as descrições dos simbolos usados para estados e transições podem ser vistos na tabela \ref{tab:automato}. Por o autômato ser simples, pode-se ver claramente que ele não apresenta estados bloqueantes, {\it dead-locks} ou {\it live-locks}, sem a necessidade do uso de ferramentas mais complexas ou de programas de simulação. \cite{book:Cassandras}

Considerando que a máquina entra no estado inicial ao ser ligada, a primeira ação que deve ocorrer é a inicialização da máquina (evento init), que indica que a máquina está pronta para realizar operações. Após ser inicializado, o sistema deve ser capaz de entrar nos diferentes modos de operação. Ao entrar em um modo de oparação específico, o sistema deve ser capaz de mover o êmbolo da seringa de acordo com as restrições desse modo. Também adicionou-se um estado que representa a ocorrência de um erro durante a operação da máquina (estado ERROR), como, por exemplo, a pressão máxima da seringa ser excedida.

\begin{table}[h]
\centering
\begin{tabular}{l|l}
Símbolo  & Descrição                                   \\\hline
ON     & Máquina ligada, mas não inicializada            \\
INIT   & Máquina ligada e inicializada                \\
STB\_M & Em modo Stand by                              \\
INJ\_M & Em modo de injeção com parâmetros não definidos  \\
INJ\_P & Em modo de injeção com parâmetros definidos     \\
INJ\_I & Injetando em modo de injeção                   \\
FIL\_M & Em modo de enchimento                               \\
FIL\_R & Retraindo em modo de enchimento (enchendo)          \\
FIL\_I & Injetando em modo de enchimento          \\
MAN\_M & Em modo manual                               \\
MAN\_R & Retraindo em modo manual                     \\
MAN\_I & Injetando em modo manual                      \\
ERROR  & Estado de erro                                   \\
init      & Eixo inicializado                        \\
fixed     & Erro foi corrigido                              \\
e         & Erro ocorreu                               \\
x         & Comando para ir para o modo x \\% (m, f, i ou s)       \\
%& (m = manual, f = enchimento, i = injeção ou s = stand by)       \\
$\sim$x   & comando para sair do modo x                      \\
xr        & Comando para retrair êmbolo no modo x         \\
$\sim$xr  & Comando para parar de retrair êmbolo no modo x \\
xi        & Comando para injetar no modo x                  \\
$\sim$xi  & Comando para parar de injetar no modo x          \\
ip        & Parâmetros de injeção foram definidos                 \\
$\sim$ip  & Retornar para a definição de parâmetros   
\end{tabular}
\caption{Descrição dos simbolos do autômato da figura \ref{fig:automato}.}
\label{tab:automato}
\end{table}

\subsection{Modelagem em rede de Petri}

Pode ser visto no autômato da figura que o usuário nunca poderia alcançar os modos de operação sem que os dois eixos fossem inicializados primeiro. No entanto, para fins de desenvolvimento, é desejável que esses modos sejam acessíveis sem o procedimento de inicialização ou com a inicialização de apenas um dos eixos. Então, foi decidido alterar os autômatos para permitir que isso acontecesse, mas com a restrição de nunca mover o êmbolo de um eixo se esse eixo não for inicializado (exceto no procedimento de inicialização). Tais mudanças e o detalhamento dos processos tornariam o autômato muito grande e complexo, por isso foi decidido modelar o sistema com uma rede Petri.

A rede de Petri projetada em nível de implementação para a máquina com um eixo com sua marcação inicial pode ser vista na figura \ref{fig:petri}. As descrições das transições são as mesmas da tabela \ref{tab:automato}. A implementação completa com dois eixos ocorre pela implementação dessa rede duas vezes, onde os lugares brancos das duas redes se sobrepõem. Ou seja, o modo de operação dos eixos sempre é o mesmo, mas o estado de cada eixo pode ser diferente. Isso é útil para quando apenas um eixo da máquina está sendo utilizado.

\begin{figure}[h]
\centering
\includegraphics[width = \linewidth]{figs/petri}
\caption{Rede de Petri projetada em nível de implementação.}
\label{fig:petri}
\end{figure}

Pode-se ver que sempre haverá uma ficha entre os lugares em verde e uma ficha fora desses lugares. A ficha entre os lugares em verde representa o estado dos eixos, representa se os eixos estão inicializados ou se ocorreu um erro no sistema. A ficha fora dos lugares em verde representa em qual modo de operação o sistema está. Observe que, se o eixo não for inicializado, a ficha fora dos lugares em verde não alcançará os lugares em azul, que representam os estados em que os êmbolos estão em movimento, conforme indicado anteriormente.

Vale ressaltar que, caso algum dos êmbolos esteja em movimento e ocorrer algum erro no sistema (evento e), as transições $\sim$xr e $\sim$xi, que são descritas na tabela \ref{tab:automato}, são acionadas de modo a parar o movimento do êmbolo. Pode-se observar também que, de acordo com a rede de Petri, uma ficha poderia transicionar do lugar MANUAL para o lugar RETRACT PLUNGER e em seguida para o lugar FILL, que seria um problema, já que essa última transição deveria ser de volta para o lugar MANUAL. Isso poderia ser simplesmente corrigido pela adição de alguns lugares adicionais na rede. Porém, como todos os eventos relacionados a essas transições são determinísticos, decidiu-se manter a rede simples e garantir que nunca ocorrerá uma sequência de eventos que resultaria em transições problemáticas como a citada.

\subsection{Simulações da rede de Petri}

Para a verificação de que rede atende corretamente aos requisitos do projeto e possui um comportamento adequado,
ela foi simulada através do programa {\it Hierarchical Petri net Simulator} (HiPS). Ele nos permite fazer análises estruturais e comportamentais da rede. Como esperado, a análise estrutural, que pode ser vista na figura \ref{fig:petriSim}, mostrou que a rede é conservadora e consistente. Através da análise comportamental, obteve-se que a rede e todas as transições são L4-vivas. Finalmente, por meio do acionamento manual das transições, verificou-se o correto comportamento do sistema. \cite{book:Cassandras}

\begin{figure}[h]
\centering
\includegraphics[width = \linewidth]{figs/petriSim}
\caption{Rede de Petri projetada em nível de implementação.}
\label{fig:petriSim}
\end{figure}

% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Modelagem dos Perfis de Injeção}

% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Escolha dos Sensores}

O sistema precisa de três tipos de sensores, transdutores de pressão, encoders e sensores ópticos.

\subsection{Escolha dos sensores de pressão}

Conforme os requisitos de projeto, transdutores de pressão devem estar presentes na saída das seringas para que o sistema de controle possa garantir que a pressão no sistema nunca ultrapasse a pressão máxima definida pelo usuário. Os transdutores escolhidos devem suportar pressões maiores do que as pressões exercidadas no sistema. Conforme calculado em \cite{article:PSDP}, a máxima força aplicada por um atuador durante uma injeção é de aproximadamente 900 lbf (4003 N). Sabendo que o diâmetro interno das seringas é de 40 mm, pode-se calcular a pressão máxima exercida pelos atuadores, de aproximadamente 460 psi. Assim, optou-se por escolher transdutores que aguentem pelo menos 1000 psi.

Escolheu sensores de pressão do modelo Model A-10 da fabricante WIKA, com faixa de medição de 0 a 1500 psi e saída analógica de 4 a 20 mA. Os sensores utilizados podem ser vistos na figura \ref{fig:transdutores}.

\begin{figure}[h]
\centering
\includegraphics[width = 0.6\textwidth]{figs/transdutores}
\caption{Sensores de pressão do modelo Model A-10 da fabricante WIKA.}
\label{fig:transdutores}
\end{figure}


\subsection{Escolha dos encoders}

De forma a garantir que a injeção ocorra de forma correta, o fluxo de injeção é monitorado por encoders incrementais, um para cada atuador. Esses encoders são acoplados a um pino que sai da caixa de engrenagem dos atuadores, que completa uma revolução para cada 0,2 polegadas movidas pelo atuador linear. Assim, é importante que se escolha um encoder que apresente resolução boa o suficiente para a realização do controle do atuador de forma satisfatória, mas que também não ultrapasse o limite de frequência de leitura do cartão da CLP ao qual estará conectado.

Sabendo que o diâmetro interno da seringa é de 40 mm, uma velocidade do atuador de 0,8 mm/s corresponde á um fluxo de 1 mL/s. Definindo um fluxo máximo de injeção de 15 mL/s, a velocidade máxima correspondente do atuador é de 12 mm/s. Assim, a resolução dos encoders deve ser tal que a frequência do sinal provindo deles quando o atuador move-se a 12 mm/s deve ser menor do que a frequência máxima de entrada dos cartões da CLP onde os encoders estão ligados. Assim, essa relação pode ser descrita por
\begin{equation}
\frac{\text{Velocidade máxima}}{k}\times \text{Resolução do encoder} \leq \text{Frequência máxima do cartão},
\end{equation}
onde $k$ é a relação de velocidade linear do atuador e velocidade rotacional do encoder de 5,08 mm/revolução.
A maioria dos cartões disponibilizados possuem uma frequência máxima de entrada de 250 kHz. Para esses cartões, a resolução máxima que os encoders podem ter é de aproximadamente 100.000 pulsos por revolução.

Inicialmente, escolheu-se encoders de 5.000 pulsos por revolução. Logo percebeu-se que a resolução era muito baixa, onde a discretização dos gráficos de posição do atuador era muito evidente. Isso causou problemas para uma obtenção precisa da velocidade do atuador, resultando em um sistema de controle com respostas insatisfatórias. Por isso, resolveu-se mudar para os encoders do modelo 847T-DM26-RQ50000 da fabricante Allen-Bradley, que são de 50.000 pulsos por revolução e aceitam alimentação de 24 Volts com saída no mesmo nível da entrada \cite{web:encoder}. O encoder escolhido pode ser visto na figura \ref{fig:enc}.

\begin{figure}[h]
\centering
\includegraphics[width = 0.5\textwidth]{figs/encoder}
\caption{Encoder do modelo 847T-DM26-RQ50000 da fabricante Allen-Bradley.}
\label{fig:enc}
\end{figure}

\subsection{Escolha dos sensores de limite ópticos}

Esses sensores funcionam como os sensores de limite para os movimentos dos atuadores. Cada atuador deve possuir dois desses sensores, uma que determina a máxima retração e outro a máxima extensão do atuador. Teoricamente, a presença dos encoders seria suficiente para a determinação da posição, mas, por questões de segurança, a presença desses sensores é essencial. Além disso, como o sistema possui encoders incrementais ao invés de absolutos, esses sensores são essenciais para a inicialização das posições dos atuadores.

Escolheu-se os sensores do modelo EE-SX77/87 T-shapped, que atende a todos os requisitos de operação. O formato desse modelo facilita sua montagem em ranhuras em T. Esse sensor aceita alimentação de 24 Volts com saída no mesmo nível da entrada. O sensor escolhido pode ser visto na figura \ref{fig:sensorOptico}.

\begin{figure}[h]
\centering
\includegraphics[angle = 270, width = 0.5\textwidth]{figs/sensorLimite}
\caption{Sensor fotoelétrico do modelo EE-SX77/87 T-shapped.}
\label{fig:sensorOptico}
\end{figure}

% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Escolha do Controlador e Seus Módulos}

Optou-se pela utilização de um CLP da empresa austríaca B{\&}R, que possui uma parceria com o Mechatronics Laboratory. Assim, todos os módulos utilizados e suporte técnico foram fornecidos pela empresa gratuitamente. Optou-se pelo uso do painel 5PP520, que contem um CLP integrado a uma tela LCD touch de 10.4 polegadas, que funciona como a interface de comunicação com o usuário. O painel 5PP520 pode ser visto na figura \ref{fig:CLP}.

\begin{figure}[h!]
\centering
\includegraphics[width = 0.5\textwidth]{figs/CLP}
\caption{Painel 5PP520, que contém um CLP e monitor LCD touch.}
\label{fig:CLP}
\end{figure}

Decidiu-se utilizar os módulos (cartões) da linha X20, que se comunicam por um barramento que utiliza o protocolo X2X fieldbus. Acrescentou-se um módulo de conversão X20BC0083 ao barramento, que comunica-se com a CLP por meio do protocolo Powerlink e também age como a fonte de alimentação do barramento. Ambos protocolos são propriedades da  B{\&}R. Uma boa característica das peças da B{\&}R é que elas se conectam facilmente ao barramento. Os módulos X20 utilizados podem ser vistos na figura \ref{fig:cartoesCLP}, onde o módulo de comunicação encontra-se a esquerda.

\begin{figure}[h!]
\centering
\includegraphics[width = 0.6\textwidth]{figs/cartoesCLP}
\caption{Módulos do CLP X20 utilizados.}
\label{fig:cartoesCLP}
\end{figure}

Para a escolha dos cartões da CLP, precisa-se definir quais são os componentes do sistema que se comunicam com ela, e como essa comunicação ocorre. Um bom método para obter essas informações é a listagem das variáveis de entrada e saída da CLP. A tabela \ref{tab:variaveis} lista todas essas variáveis.

\begin{table}[h!]
\centering
\begin{tabular}{l|l}
 Variável & Tipo \\ 
 \hline 
 Encoder 1 & Entrada digital tipo encoder AB \\ 
 Encoder 2 & Entrada digital tipo encoder AB \\ 
 Sensor de limite extendido 1 & Entrada digital 24V \\ 
 Sensor de limite retraido 1 & Entrada digital 24V \\ 
 Sensor de limite extendido 2 & Entrada digital 24V \\ 
 Sensor de limite retraido 2 & Entrada digital 24V \\ 
 Sensor de pressão 1 & Entrada analógica 4...20mA \\ 
 Sensor de pressão 2 & Entrada analógica 4...20mA \\ 
 Controle do atuador 1 & Saída analógica 0...5V \\ 
 Controle do atuador 2 & Saída analógica 0...5V \\ 
 Controle do relé dos atuadores & Saída digital 24V \\ 
 \end{tabular}  
 \caption{Lista de variáveis de entrada e saída da CLP.}
 \label{tab:variaveis}
\end{table}

Com base na tabela, os cartões necessários foram escolhidos. A configuração completa do sistema de controle pode ser vista na figura \ref{fig:CLPconfig}, onde os cartões de entradas e saídas utilizados estão dentro do barramento X2X. 

\begin{figure}[h!]
\centering
\includegraphics[width = 0.45\textwidth]{figs/CLPconfig}
\caption{Configuração completa do sistema de controle.}
\label{fig:CLPconfig}
\end{figure}

% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Diagramas elétricos}

O sistema foi dividido em dois diagramas, um que mostra apenas as conexões entre os sensores e os cartões do CLP e outro para todas as outras conexões (controle do sistema e dos atuadores através de um amplificador). Os diagramas podem ser vistos nas figuras \ref{fig:diagrama1} e \ref{fig:diagrama2} e em anexo ao final do relatório, onde estão em maior escala e possuem tabelas de sinais. 

\begin{figure}[h!]
\centering
\includegraphics[angle = 270, width = \textwidth]{figs/Electrical1}
\caption{Diagrama elétrico 1.}
\label{fig:diagrama1}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[angle = 270, width = \textwidth]{figs/Electrical2}
\caption{Diagrama elétrico 2.}
\label{fig:diagrama2}
\end{figure}

Em vez de usar o módulo de motor PWM da B{\&}R, optou-se por usar um amplificador Sabertooth 2x60, que é capaz de fornecer até 60A a cada motor. Ele recebe uma entrada analógica de 0 a 5V DC do CLP e fornece uma saída para os motores de -24 a 24V DC. Uma tensão analógica de 2.5V não corresponde a nenhum movimento. Os sinais acima de 2.5V comandam um movimento de extensão e os sinais abaixo de 2.5V comandam um movimento de retração. \cite{saber}

O relé que pode ser visto no diagrama elétrico principal é usado para habilitar o movimento dos atuadores. Recebe um sinal de controle do CLP e corta a alimentação do amplificador quando os motores não devem ser movidos (no modo Stand By e quando o CLP está inicializando).

Notou-se que existe um ao alto consumo de corrente dos atuadores. Um dos atuadores apresenta motor com resistência de circuito da armadura de 0,5$\Omega$, gerando picos de corrente contínua muito altos durante o movimento de partida do motor.
Assim, optou-se pela utilização de duas fontes de alimentação, uma exclusivamente para a alimentação dos atuadores e outra para o restante do sistema.

% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Tela de Supervisório e Interface de Usuário}

O usuário comunica-se com o sistema através da tela LCD integrada ao CLP, onde o controlador mostra as informações atuais do sistema e o usuário consegue interagir com o controlador, selecionando o modo de operação atual e definindo parâmetros de injeção. As páginas da interface foram feitas com o programa  Automation Studio da B{\&}R, onde elas podem ser diretamente integradas aos programas do controlador. Todas as páginas desenvolvidas podem ser vistas em anexo ao fim do relatório. 

Uma das páginas pode ser vista na figura \ref{fig:pagInjecao}, a página mostrada durante os procedimentos de injeções. Os quadrados verdes no canto superior da página indicam que os dois eixos estão inicializados e não apresentam erros, eles ficam vermelhos caso contrário. Esses quadrados estão presentes em todas as páginas. A mensagem "Max Pressure Reached"  aparece somente quando a pressão em algum dos eixos ultrapassou a pressão máxima definida pelo usuário. O gráfico mostra o fluxo de injeção em tempo real dos dois eixos.
 A página também mostra o nível de fluido e pressão lida nas duas seringas.
 
 \begin{figure}[h!]
\centering
\includegraphics[width = .7\textwidth]{figs/InjePage}
\caption{Página mostrada na tela LCD durante os procedimentos de injeções.}
\label{fig:pagInjecao}
\end{figure}

% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
% -------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Controle dos Atuadores}

\section{Configuração de Hardware da CLP}


